---
title: "Systematic Review of Ionized Magnesium"
author: "Sasha Haywood, Chen Zhou"
date: "3/17/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include = F}
library(readr)
library(dplyr)
iMg = read_csv("iMg_EXTRACTION_Resultsfinal_Ansu.csv")
iMg = iMg[,c(1, 4, 7, 9, 10, 11, 12)] # 261 rows
iMg = iMg[!is.na(iMg$grp1_base_mean),] # remove 18 rows without means
iMg = iMg[!is.na(iMg$grp1_base_n),] # remove 10 rows without sample sizes
iMg = unite(iMg, group, 2:3, remove = T)

# replace missing sd with sd calculated from se and n
missing.sd = is.na(iMg$grp1_base_sd)
iMg$grp1_base_sd[missing.sd] = with(iMg, grp1_base_se[missing.sd] * 
                                      sqrt(grp1_base_n[missing.sd]))
iMg = iMg[!is.na(iMg$grp1_base_sd),] # remove 22 rows without sd
  
groups = iMg %>%
  group_by(group) %>%
  mutate(n = sum(grp1_base_n)) %>%
  mutate(weighted.mean = grp1_base_mean * grp1_base_n / (n-1)) %>%
  mutate(overall_mean = sum(weighted.mean)) %>%
  mutate(q = (grp1_base_n - 1) * grp1_base_sd^2 + grp1_base_n * grp1_base_mean^2) %>%
  mutate(qc = sum(q)) %>%
  mutate(overall_var = (qc - n * overall_mean^2) / (n-1)) %>%
  mutate(overall_sd = sqrt((qc - n * overall_mean^2) / (n-1)))

report1 = groups[,c(2, 9, 13)]

######### alternate code 
########## this code leave in the lines that only have mean until overall mean has been calculated
############ and then it removes those lines and recalculates n and calculates overall sd

iMg = read_csv("iMg_EXTRACTION_Resultsfinal_Ansu.csv")
iMg = iMg[,c(1, 4, 7, 9, 10, 11, 12)] # 261 rows
iMg = iMg[!is.na(iMg$grp1_base_mean),] # remove 18 rows without means
iMg = iMg[!is.na(iMg$grp1_base_n),] # remove 10 rows without sample sizes
iMg = unite(iMg, group, 2:3, remove = T)

# replace missing sd with sd calculated from se and n
missing.sd = is.na(iMg$grp1_base_sd)
iMg$grp1_base_sd[missing.sd] = with(iMg, grp1_base_se[missing.sd] * 
                                      sqrt(grp1_base_n[missing.sd]))


groups = iMg %>%
  group_by(group) %>%
  mutate(n = sum(grp1_base_n)) %>%
  mutate(weighted.mean = grp1_base_mean * grp1_base_n / (n-1)) %>%
  mutate(overall_mean = sum(weighted.mean))

groups = groups[!is.na(groups$grp1_base_sd),] # remove 22 rows without sd

groups = groups %>%
  mutate(new_n = sum(grp1_base_n)) %>%
  mutate(q = (grp1_base_n - 1) * grp1_base_sd^2 + grp1_base_n * grp1_base_mean^2) %>%
  mutate(qc = sum(q)) %>%
  mutate(overall_var = (qc - new_n * overall_mean^2) / (n-1)) %>%
  mutate(overall_sd = sqrt((qc - new_n * overall_mean^2) / (n-1)))

report2 = groups[,c(2, 9, 14)]

```

# Introduction
The end goal of this project is to determine a reference range for ionized magnesium and total magnesium concentrate in people with different health conditions.  The results from a number of studies have been compiled, and our initial objective is to combine the means and standard deviations from those seperate studies.  The initial collection of data includes studies of people with five different health conditions.
* diabetes 
* hypertension
* renal disease
* cardiovascular disease
* healthy
For each health condition, there are two measurements.
* ionized magnesium 
* total magnesium concentration.

# The Data
The data set contains one observation for each study/group/condition/measurement combination.  Not all conditions are included in all studies.  For example, there are 24 study/group observations reporting ionized magnesium in people with cardiovascular disease, but only one reporting total magnesium in people with hypertension.  Studies range in size from samples of 6 to 1,652 people.  For each study, we should have sample size, mean, and standard deviation or standard error.  In the cases where the mean or sample size is missing, there is no way to include the observation in a weighted mean.  This includes 28 rows which must be excluded from the calculation.  A number of observations have a reported standard error, but no standard deviation.  In those cases, the standard deviation has been calculated using the following formula:
se * sqrt(sample size)
After making this calculation, there remain 22 obervations with no standard deviation.  We have managed this discrepancy in two different ways, explained as follows.

# The Math
The weighted means are calculated using the formula
grp1_base_mean * grp1_base_n / (n-1)

The weighted standard deviations are calculated using the formula
sqrt(sum((grp1_base_n - 1) * grp1_base_sd^2 + grp1_base_n * grp1_base_mean^2)- n * overall_mean^2) / (n-1))

# Two Methods
In our first method, we started by removed the observations with missing standard deviations.   We then calculated the weighted mea and weighted standard deviations without those observations.

In our second method, we calculated the weighted mean using all observations for which we had both n and mean.  We then removed the 22 observations with no standard deviation, recalculated the total sample sizes (n) and calculated the standard deviation. In our opinion, this is a valid method for analysis and is preferred, as it includes as much information as is available.

# The Results
  
Method 1
group                   overall_mean overall_sd
   <chr>                          <dbl>      <dbl>
 1 CVD_iMg                        0.504     0.0718
 2 CVD_Total Mg                   0.842     0.0985
 3 Healthy_iMg                    0.541     0.0659
 4 Healthy_Total Mg               0.856     0.0701
 5 Diabetes_Total Mg              0.846     0.113 
 6 Diabetes_iMg                   0.498     0.137 
 7 Renal disease_Total Mg         0.941     0.190 
 8 Renal disease_iMg              0.573     0.104 
 9 Hypertension_iMg               0.643     0.128 
10 Hypertension_Total Mg          0.935     0.080     
11 Healthy_Serum magnesium        0.817     0.055    

 Method 2
   group                   overall_mean overall_sd
   <chr>                          <dbl>      <dbl>
 1 CVD_iMg                        0.504     0.0718
 2 CVD_Total Mg                   0.842     0.0985
 3 Healthy_iMg                    0.539     0.0798
 4 Healthy_Total Mg               0.854     0.0873
 5 Diabetes_Total Mg              0.846     0.113 
 6 Diabetes_iMg                   0.498     0.137 
 7 Renal disease_Total Mg         0.947     0.150 
 8 Renal disease_iMg              0.577     0.0768
 9 Hypertension_iMg               0.643     0.128 
10 Hypertension_Total Mg          0.935     0.080    
11 Healthy_Serum magnesium        0.817     0.055
